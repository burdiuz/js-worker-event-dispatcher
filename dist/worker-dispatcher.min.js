!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).WorkerDispatcher={})}(this,function(e){"use strict";const t={DEDICATED_WORKER:"dedicated",SHARED_WORKER:"shared",SHARED_WORKER_SERVER:"sharedServer",SHARED_WORKER_CLIENT:"sharedClient",SERVICE_WORKER:"service",SERVICE_WORKER_SERVER:"serviceServer",SERVICE_WORKER_CLIENT:"serviceClient"};function s(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function r(e,t){return e(t={exports:{}},t.exports),t.exports}var n=r(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});const s=(e=>(t,s)=>Boolean(t&&e.call(t,s)))(Object.prototype.hasOwnProperty);t.hasOwn=s,t.default=s});s(n);n.hasOwn;var i=r(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s,r=(s=n)&&"object"==typeof s&&"default"in s?s.default:s;const i=e=>"object"==typeof e&&null!==e;class a{constructor(e,t=null){this.type=e,this.data=t,this.defaultPrevented=!1}toJSON(){return{type:this.type,data:this.data}}isDefaultPrevented(){return this.defaultPrevented}preventDefault(){this.defaultPrevented=!0}}const o=(e,t)=>{let s=e;return i(e)||(s=new a(String(e),t)),s};class c{constructor(e,t,s){this.index=-1,this.immediatelyStopped=!1,this.stopImmediatePropagation=()=>{this.immediatelyStopped=!0},this.listeners=e,this.onStopped=t,this.onComplete=s}run(e,t){let s;const{listeners:r}=this;for(this.augmentEvent(e),this.index=0;this.index<r.length&&!this.immediatelyStopped;this.index++)(s=r[this.index]).call(t,e);this.clearEvent(e),this.onComplete(this)}augmentEvent(e){const t=e;t.stopPropagation=this.onStopped,t.stopImmediatePropagation=this.stopImmediatePropagation}clearEvent(e){const t=e;delete t.stopPropagation,delete t.stopImmediatePropagation}listenerRemoved(e,t){e===this.listeners&&t<=this.index&&this.index--}}class E{constructor(){this._listeners={},this._runners=[],this.removeRunner=e=>{this._runners.splice(this._runners.indexOf(e),1)}}createList(e,t){const s=parseInt(t,10),n=this.getPrioritiesByKey(e),i=String(s);let a;return r(n,i)?a=n[i]:(a=[],n[i]=a),a}getPrioritiesByKey(e){let t;return r(this._listeners,e)?t=this._listeners[e]:(t={},this._listeners[e]=t),t}add(e,t,s){const r=this.createList(e,s);r.indexOf(t)<0&&r.push(t)}has(e){let t,s=!1;const n=this.getPrioritiesByKey(e);if(n)for(t in n)if(r(n,t)){s=!0;break}return s}remove(e,t){const s=this.getPrioritiesByKey(e);if(s){const e=Object.getOwnPropertyNames(s),{length:r}=e;for(let n=0;n<r;n++){const r=e[n],i=s[r],a=i.indexOf(t);a>=0&&(i.splice(a,1),i.length||delete s[r],this._runners.forEach(e=>{e.listenerRemoved(i,a)}))}}}removeAll(e){delete this._listeners[e]}createRunner(e,t){const s=new c(e,t,this.removeRunner);return this._runners.push(s),s}call(e,t){const s=this.getPrioritiesByKey(e.type);let r=!1;const n=()=>{r=!0};if(s){const i=Object.getOwnPropertyNames(s).sort((e,t)=>e-t),{length:a}=i;for(let o=0;o<a&&!r;o++){const r=s[i[o]];if(r){const s=this.createRunner(r,n);if(s.run(e,t),s.immediatelyStopped)break}}}}}class h{constructor(e=null){this._eventPreprocessor=e,this._listeners=new E}addEventListener(e,t,s=0){this._listeners.add(e,t,-s||0)}hasEventListener(e){return this._listeners.has(e)}removeEventListener(e,t){this._listeners.remove(e,t)}removeAllEventListeners(e){this._listeners.removeAll(e)}dispatchEvent(e,t){let s=o(e,t);this._eventPreprocessor&&(s=this._eventPreprocessor.call(this,s)),this._listeners.call(s)}}t.default=h,t.Event=a,t.EventDispatcher=h,t.createEventDispatcher=e=>new h(e),t.getEvent=o,t.isObject=i});s(i);var a=i.Event,o=(i.EventDispatcher,i.createEventDispatcher),c=(i.getEvent,i.isObject);const E={CONNECT:"connect",MESSAGE:"message",ERROR:"error",MESSAGEERROR:"messageerror",LANGUAGECHANGE:"languagechange",ONLINE:"online",OFFLINE:"offline",INSTALL:"install",ACTIVATE:"activate",FETCH:"fetch",SYNC:"sync",PUSH:"push"};class h extends a{constructor(e,t,s,r){super(e,t),this.nativeEvent=s,this.client=r}}h.CONNECT="worker:connect",h.MESSAGE="worker:message",h.ERROR="worker:error",h.MESSAGEERROR="messageerror",h.LANGUAGECHANGE="worker:languagechange",h.ONLINE="worker:online",h.OFFLINE="worker:offline";const l=(e,t,s)=>{const r=(e=>{switch(e){case E.CONNECT:return h.CONNECT;case E.MESSAGE:return h.MESSAGE;case E.ERROR:return h.ERROR;case E.MESSAGEERROR:return h.MESSAGEERROR;case E.LANGUAGECHANGE:return h.LANGUAGECHANGE;case E.ONLINE:return h.ONLINE;case E.OFFLINE:return h.OFFLINE;case E.INSTALL:return h.INSTALL;case E.ACTIVATE:return h.ACTIVATE;case E.FETCH:return h.FETCH;case E.SYNC:return h.SYNC;case E.PUSH:return h.PUSH;default:return e}})(e),n=e=>{s.hasEventListener(r)&&s.dispatchEvent(new h(r,e,e))};return t.addEventListener(e,n),n},v=(e,t)=>{l(E.ERROR,e,t),l(E.LANGUAGECHANGE,e,t),l(E.ONLINE,e,t),l(E.OFFLINE,e,t)},d=(e,t)=>{l(E.ERROR,e,t),l(E.MESSAGEERROR,e,t)};var p=r(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s,r=(s=n)&&"object"==typeof s&&"default"in s?s.default:s;const a=()=>`MP/${Math.ceil(1e4*Math.random())}/${Date.now()}`,o=e=>"function"==typeof e.toJSON?e.toJSON():JSON.stringify(e),c=e=>{if(i.isObject(e))return e;try{return JSON.parse(e)}catch(e){}};class E{constructor(e,t){this.event=e,this.dispatcherId=t}toJSON(){return{event:o(this.event),dispatcherId:this.dispatcherId}}}const h=e=>i.isObject(e)&&r(e,"dispatcherId")&&r(e,"event"),l=e=>{const t=c(e);if(t&&h(t)){const{event:e,dispatcherId:s}=t;return new E(c(e),s)}return null};class v{constructor(e=null,t=null,s=null,r=null){this.dispatcherId=a(),this.targetOrigin="*",this.target=e||self,this.customPostMessageHandler=t,this.senderEventPreprocessor=r,this.sender=i.createEventDispatcher(),this.receiver=i.createEventDispatcher(s),this.target.addEventListener("message",e=>this._postMessageListener(e))}addEventListener(e,t,s){this.receiver.addEventListener(e,t,s)}hasEventListener(e){return this.receiver.hasEventListener(e)}removeEventListener(e,t){this.receiver.removeEventListener(e,t)}removeAllEventListeners(e){this.receiver.removeAllEventListeners(e)}dispatchEvent(e,t,s){let r=i.getEvent(e,t);this.senderEventPreprocessor&&(r=this.senderEventPreprocessor.call(this,r));const n=o(new E(r,this.dispatcherId));return this._postMessageHandler(n,s)}_postMessageHandler(e,t){const s=this.customPostMessageHandler;return s?s.call(this,e,this.targetOrigin,t):this.target.postMessage(e,this.targetOrigin,t)}_postMessageListener(e){e=e.nativeEvent||e;const t=l(e.data);t&&(t.dispatcherId===this.dispatcherId?this.sender.dispatchEvent(t.event):this.receiver.dispatchEvent(t.event))}}const d=(e,t,s,r)=>new v(e,t,s,r),p=(e,t=null)=>()=>(t||(t=d(e())),t),u=p(()=>self),R=p(()=>parent),g=p(()=>top);t.MessagePortDispatcher=v,t.MessagePortEvent=E,t.createMessagePortDispatcher=d,t.default=v,t.factory=p,t.getForParent=R,t.getForSelf=u,t.getForTop=g,t.isMessagePortEvent=h,t.parseMessagePortEvent=l}),u=s(p),R=(p.MessagePortDispatcher,p.MessagePortEvent,p.createMessagePortDispatcher,p.factory,p.getForParent,p.getForSelf,p.getForTop,p.isMessagePortEvent,p.parseMessagePortEvent);class g extends u{constructor(e,t,s=null,r=null){super(t,(e,s,r)=>t.postMessage(e,r),s,r),this.type=e}}const S=e=>{let t=e||self;return c(t)||(t=new Worker(String(e))),t};class O extends g{constructor(e,s,r){super(t.DEDICATED_WORKER,S(e),s,r),v(this.target,this.receiver)}terminate(){return this.target.terminate()}}const f=(e,t)=>c(e)?e:new SharedWorker(String(e),t);class _ extends g{constructor(e,s,r,n){const i=f(e,s);super(t.SHARED_WORKER,i.port,r,n),this.worker=i,d(this.worker,this.receiver),this.start()}start(){this.target.start()}close(){this.target.close()}}class L extends g{constructor(e,s,r){super(t.SHARED_WORKER_CLIENT,e,s,r)}start(){this.target.start()}close(){this.target.close()}}class N{constructor(e=self,s,r,n){C.call(this),this.type=t.SHARED_WORKER_SERVER,this.target=e,this.clientFactory=e=>new L(e,r,n),this.receiver=o(s),this.target.addEventListener(E.CONNECT,this.handleConnect),v(this.target,this.receiver)}}var C=function(){this.addEventListener=(...e)=>this.receiver.addEventListener(...e),this.hasEventListener=(...e)=>this.receiver.hasEventListener(...e),this.removeEventListener=(...e)=>this.receiver.removeEventListener(...e),this.removeAllEventListeners=(...e)=>this.receiver.removeAllEventListeners(...e),this.handleConnect=e=>{const[t]=e.ports,s=this.clientFactory(t);this.receiver.dispatchEvent(new h(h.CONNECT,s,e,s))}};const m=()=>{const e=new MessageChannel;let t=!1;return{postMessage:async s=>{const r=await(async()=>{return await navigator.serviceWorker.ready,(await navigator.serviceWorker.getRegistration()).active})();return t?r.postMessage(s):(t=!0,r.postMessage(s,[e.port2]))},get onmessage(){return e.port1.onmessage},set onmessage(t){e.port1.onmessage=t},start:()=>{e.port1.start()},close:()=>{e.port1.close()},addEventListener:(...t)=>e.port1.addEventListener(...t)}};class y extends g{constructor(e,s){super(t.SERVICE_WORKER,m(),e,s),this.start(),d(this.target,this.receiver)}start(){return this.target.start()}close(){return this.target.close()}onReady(e){return navigator.serviceWorker.ready.then(e)}get ready(){return navigator.serviceWorker.ready}}class A extends g{constructor(e,s,r){super(t.SERVICE_WORKER_CLIENT,e,s,r)}start(){this.target.start()}close(){this.target.close()}}class I{constructor(e=self,s,r,n){this.addEventListener=(...e)=>this.receiver.addEventListener(...e),this.hasEventListener=(...e)=>this.receiver.hasEventListener(...e),this.removeEventListener=(...e)=>this.receiver.removeEventListener(...e),this.removeAllEventListeners=(...e)=>this.receiver.removeAllEventListeners(...e),this.type=t.SERVICE_WORKER_SERVER,this.target=e,this.clientFactory=e=>e?new A(e,r,n):null,this.receiver=o(s),d(e,this.receiver),e.addEventListener(E.MESSAGE,e=>this._postMessageListener(e))}_postMessageListener(e){const{data:t,ports:[s]}=e;if(!t)return;const{event:{type:r,data:n}}=R(t),i=new h(r,n,e,this.clientFactory(s));this.receiver.dispatchEvent(i)}}const D=(e,t,s)=>new O(e,t,s),P=(e,t,s)=>new _(e,null,t,s),w=(e,t)=>new y(e,t),M=h.CONNECT,{DEDICATED_WORKER:W,SHARED_WORKER:T,SERVICE_WORKER:K}=t;e.CONNECT_EVENT=M,e.DEDICATED_WORKER=W,e.DedicatedWorkerDispatcher=O,e.NativeEventType=E,e.SERVICE_WORKER=K,e.SHARED_WORKER=T,e.ServiceClientDispatcher=A,e.ServiceServerDispatcher=I,e.ServiceWorkerDispatcher=y,e.SharedClientDispatcher=L,e.SharedServerDispatcher=N,e.SharedWorkerDispatcher=_,e.WorkerEvent=h,e.WorkerType=t,e.create=(e,s,r,n)=>{switch(s){default:case t.DEDICATED_WORKER:return D(e,r,n);case t.SHARED_WORKER:return P(e,r,n);case t.SHARED_WORKER_SERVER:return new N(e,r);case t.SHARED_WORKER_CLIENT:return new L(e,r,n);case t.SERVICE_WORKER:return w(r,n);case t.SERVICE_WORKER_SERVER:return new I(e,r);case t.SERVICE_WORKER_CLIENT:return new A(e,r,n)}},e.createForDedicatedWorker=D,e.createForSelf=(e,t)=>"function"==typeof self.postMessage?new O(self,e,t):self.registration&&"string"==typeof self.registration.scope?new I(self,e):new N(self,e),e.createForServiceWorker=w,e.createForSharedWorker=P,e.default=O,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=worker-dispatcher.min.js.map
