!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.WorkerEventDispatcher=t()}(this,function(){function e(e,t,n,r){a.Event.call(this,e,t),this.sourceEvent=n,this.client=r}function t(t,n){function r(t){var n=o.create(t.ports[0],u.SHARED_WORKER_CLIENT);s.dispatchEvent(new e(e.CONNECT,n,t,n))}var i=t||self,s=new a(n);i.addEventListener("connect",r),this.addEventListener=s.addEventListener,this.hasEventListener=s.hasEventListener,this.removeEventListener=s.removeEventListener,this.removeAllEventListeners=s.removeAllEventListeners,v.setScopeHandlers(i,s),Object.defineProperties(this,{receiver:{value:s},target:{value:i}})}function n(e,t,n){function r(){e.start()}function i(){e.close()}v.call(this,e,t,n),this.start=r,this.close=i}function r(e,t,r,i){var o=e;a.isObject(e)||(o=new SharedWorker(String(e),t)),n.call(this,o.port,r,i),v.setAbstractWorkerHandlers(o,this.receiver)}function i(e,t,n){function r(){return i.terminate()}var i=e||self;a.isObject(i)||(i=new Worker(String(e))),v.call(this,i,t,n),v.setScopeHandlers(i,this.receiver),this.terminate=r}function o(e,t,n,r){e===c?Object.defineProperties(this,{type:{value:r}}):i.call(this,e,t,n)}var a=function(){function e(e){return"object"==typeof e&&null!==e}function t(e){function n(e,t,n){c.add(e,t,-n||0)}function r(e){return c.has(e)}function o(e,t){c.remove(e,t)}function a(e){c.removeAll(e)}function s(n,r){var i=t.getEvent(n,r);e&&(i=e.call(this,i)),c.call(i)}var c=new i;this.addEventListener=n,this.hasEventListener=r,this.removeEventListener=o,this.removeAllEventListeners=a,this.dispatchEvent=s}function n(e,n){var r=e;return t.isObject(e)||(r=new t.Event(String(e),n)),r}var r=function(){function e(){return{type:this.type,data:this.data}}function t(e,t){function n(){return i}function r(){i=!0}var i=!1;Object.defineProperties(this,{type:{value:e,enumerable:!0},data:{value:t||null,enumerable:!0}}),this.preventDefault=r,this.isDefaultPrevented=n}return t.prototype.toJSON=e,t}(),i=function(){function e(e,t,n){var r=o(e,n,this._listeners);r.indexOf(t)<0&&r.push(t)}function t(e){var t=!1,n=a(e,this._listeners);if(n)for(var r in n)if(n.hasOwnProperty(r)){t=!0;break}return t}function n(e,t){var n=a(e,this._listeners);if(n)for(var r=Object.getOwnPropertyNames(n),i=r.length,o=0;i>o;o++){var s=r[o],c=n[s],l=c.indexOf(t);l>=0&&(c.splice(l,1),c.length||delete n[s])}}function r(e){delete this._listeners[e]}function i(e,t){function n(){i=!0}function r(){o=!0}var i=!1,o=!1;e.stopPropagation=n,e.stopImmediatePropagation=r;var s=a(e.type,this._listeners);if(s)for(var c=Object.getOwnPropertyNames(s).sort(function(e,t){return e-t}),l=c.length,u=0;l>u&&!i;u++)for(var v=s[c[u]],E=v.length,f=0;E>f&&!o;f++){var p=v[f];p.call(t,e)}delete e.stopPropagation,delete e.stopImmediatePropagation}function o(e,t,n){var r=a(e,n,Object);return a(parseInt(t),r,Array)}function a(e,t,n){var r=null;return t.hasOwnProperty(e)?r=t[e]:n&&(r=t[e]=new n),r}function s(){this._listeners={}}return s.prototype.add=e,s.prototype.has=t,s.prototype.remove=n,s.prototype.removeAll=r,s.prototype.call=i,s}();return t.isObject=e,t.getEvent=n,t.Event=r,t}(),s=function(){function e(n,r,i,o){function s(e){var n=t.fromJSON(e.data);n&&(n.dispatcherId===l?v.dispatchEvent(n.event):E.dispatchEvent(n.event))}function c(n,r,i){n=a.getEvent(n,r),o&&(n=o.call(this,n));var s=e.toJSON(new t(n,l));u.call(this,s,i)}n=n||self;var l="MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now()),u=r||function(e,t){n.postMessage(e,this.targetOrigin,t)},v=new a,E=new a(i);this.targetOrigin="*",this.addEventListener=E.addEventListener,this.hasEventListener=E.hasEventListener,this.removeEventListener=E.removeEventListener,this.removeAllEventListeners=E.removeAllEventListeners,this.dispatchEvent=c,Object.defineProperties(this,{sender:{value:v},receiver:{value:E},target:{value:n},dispatcherId:{value:l}}),n.addEventListener("message",s)}var t=function(){function t(e,t){this.event=e,this.dispatcherId=t}function n(){return{event:e.toJSON(this.event),dispatcherId:this.dispatcherId}}function r(n){var r=e.fromJSON(n);return t.isEvent(r)?r.event=e.fromJSON(r.event):r=null,r}function i(e){return a.isObject(e)&&e.hasOwnProperty("dispatcherId")&&e.hasOwnProperty("event")}return t.prototype.toJSON=n,t.fromJSON=r,t.isEvent=i,t}();e.toJSON=function(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)},e.fromJSON=function(e){var t;if(a.isObject(e))t=e;else try{t=JSON.parse(e)}catch(n){}return t};var n=null,r=null,i=null;return e.self=function(t,r){return n||(n=new e(self,null,t,r)),n},e.parent=function(t,n){return r||(r=new e(parent,null,t,n)),r},e.top=function(t,n){return i||(i=new e(top,null,t,n)),i},e}(),c={},l={};Object.defineProperties(l,{CONNECT:{value:"connect"},MESSAGE:{value:"message"},ERROR:{value:"error"},LANGUAGECHANGE:{value:"languagechange"},ONLINE:{value:"online"},OFFLINE:{value:"offline"}}),e.createHandler=function(t,n,r){function i(t){r.hasEventListener(o)&&r.dispatchEvent(new e(o,t,t))}var o=e.getWorkerEventType(t);return n.addEventListener(t,i),i},e.getWorkerEventType=function(t){var n="";switch(t){case l.CONNECT:n=e.CONNECT;break;case l.MESSAGE:n=e.MESSAGE;break;case l.ERROR:n=e.ERROR;break;case l.LANGUAGECHANGE:n=e.LANGUAGECHANGE;break;case l.ONLINE:n=e.ONLINE;break;case l.OFFLINE:n=e.OFFLINE}return n},Object.defineProperties(e,{CONNECT:{value:"worker:connect"},MESSAGE:{value:"worker:message"},ERROR:{value:"worker:error"},LANGUAGECHANGE:{value:"worker:languagechange"},ONLINE:{value:"worker:online"},OFFLINE:{value:"worker:offline"}});var u={};Object.defineProperties(u,{DEDICATED_WORKER:{value:"dedicated"},SHARED_WORKER:{value:"shared"},SHARED_WORKER_SERVER:{value:"sharedServer"},SHARED_WORKER_CLIENT:{value:"sharedClient"}});var v=function(){function t(e,t,n){function r(t,n){e.postMessage(t,n)}s.call(this,e,r,t,n)}function n(t,n){e.createHandler(l.ERROR,t,n),e.createHandler(l.LANGUAGECHANGE,t,n),e.createHandler(l.ONLINE,t,n),e.createHandler(l.OFFLINE,t,n)}function r(t,n){e.createHandler(l.ERROR,t,n)}return t.setScopeHandlers=n,t.setAbstractWorkerHandlers=r,t}();return t.prototype=new o(c,null,null,u.SHARED_WORKER_SERVER),t.prototype.constructor=t,n.prototype=new o(c,null,null,u.SHARED_WORKER_CLIENT),n.prototype.constructor=n,r.prototype=new o(c,null,null,u.SHARED_WORKER),r.prototype.constructor=r,i.prototype=new o(c,null,null,u.DEDICATED_WORKER),i.prototype.constructor=i,o.WorkerEvent=e,o.WorkerType=u,o.CONNECT_EVENT=e.CONNECT,o.DEDICATED_WORKER=u.DEDICATED_WORKER,o.SHARED_WORKER=u.SHARED_WORKER,o.DedicatedWorker=i,o.SharedWorker=r,o.Server=t,o.Client=n,o.create=function(e,o,a,s){var c=null;switch(o){default:case u.DEDICATED_WORKER:c=new i(e,a,s);break;case u.SHARED_WORKER:c=new r(e,null,a,s);break;case u.SHARED_WORKER_SERVER:c=new t(e,a);break;case u.SHARED_WORKER_CLIENT:c=new n(e,a,s)}return c},o.self=function(e,n){var r=null;return r="function"==typeof self.postMessage?new i(self,e,n):new t(self,e)},o});