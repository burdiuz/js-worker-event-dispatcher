!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.WorkerEventDispatcher=t()}(this,function(){function e(e,t,n,r){a.Event.call(this,e,t),this.sourceEvent=n,this.client=r}function t(t){function n(t){var n=o.create(t.ports[0],v.SHARED_WORKER_CLIENT);i.dispatchEvent(new e(e.CONNECT,n,t,n))}var r=t||self,i=new a;r.addEventListener("connect",n),this.addEventListener=i.addEventListener,this.hasEventListener=i.hasEventListener,this.removeEventListener=i.removeEventListener,this.removeAllEventListeners=i.removeAllEventListeners,l.setScopeHandlers(r,i),Object.defineProperties(this,{receiver:{value:i},target:{value:r}})}function n(e){function t(){e.start()}function n(){e.close()}l.call(this,e),this.start=t,this.close=n}function r(e,t){var r=e;a.isObject(e)||(r=new SharedWorker(String(e),t)),n.call(this,r.port),l.setAbstractWorkerHandlers(r,this.receiver)}function i(e){function t(){return n.terminate()}var n=e||self;a.isObject(n)||(n=new Worker(String(e))),l.call(this,n),l.setScopeHandlers(n,this.receiver),this.terminate=t}function o(e,t){e===c?Object.defineProperties(this,{type:{value:t}}):i.call(this,e)}var a=function(){function e(e){return"object"==typeof e&&null!==e}function t(){function e(e,t,n){s.add(e,t,-n||0)}function n(e){return s.has(e)}function r(e,t){s.remove(e,t)}function o(e){s.removeAll(e)}function a(e,n){s.call(t.getEvent(e,n))}var s=new i;this.addEventListener=e,this.hasEventListener=n,this.removeEventListener=r,this.removeAllEventListeners=o,this.dispatchEvent=a}function n(e,n){var r=e;return t.isObject(e)||(r=new t.Event(String(e),n)),r}var r=function(){function e(){return{type:this.type,data:this.data}}function t(e,t){function n(){return i}function r(){i=!0}var i=!1;Object.defineProperties(this,{type:{value:e,enumerable:!0},data:{value:t||null,enumerable:!0}}),this.preventDefault=r,this.isDefaultPrevented=n}return t.prototype.toJSON=e,t}(),i=function(){function e(e,t,n){var r=o(e,n,this._listeners);r.indexOf(t)<0&&r.push(t)}function t(e){var t=!1,n=a(e,this._listeners);if(n)for(var r in n)if(n.hasOwnProperty(r)){t=!0;break}return t}function n(e,t){var n=a(e,this._listeners);if(n)for(var r=Object.getOwnPropertyNames(n),i=r.length,o=0;i>o;o++){var s=r[o],c=n[s],u=c.indexOf(t);u>=0&&(c.splice(u,1),c.length||delete n[s])}}function r(e){delete this._listeners[e]}function i(e,t){function n(){i=!0}function r(){o=!0}var i=!1,o=!1;e.stopPropagation=n,e.stopImmediatePropagation=r;var s=a(e.type,this._listeners);if(s)for(var c=Object.getOwnPropertyNames(s).sort(function(e,t){return e-t}),u=c.length,v=0;u>v&&!i;v++)for(var l=s[c[v]],E=l.length,f=0;E>f&&!o;f++){var p=l[f];p.call(t,e)}delete e.stopPropagation,delete e.stopImmediatePropagation}function o(e,t,n){var r=a(e,n,Object);return a(parseInt(t),r,Array)}function a(e,t,n){var r=null;return t.hasOwnProperty(e)?r=t[e]:n&&(r=t[e]=new n),r}function s(){this._listeners={}}return s.prototype.add=e,s.prototype.has=t,s.prototype.remove=n,s.prototype.removeAll=r,s.prototype.call=i,s}();return t.isObject=e,t.getEvent=n,t.Event=r,t}(),s=function(){function e(n,r){function i(e){var n=t.fromJSON(e.data);n&&(n.dispatcherId===s?u.dispatchEvent(n.event):v.dispatchEvent(n.event))}function o(n,r,i){n=a.getEvent(n,r);var o=e.toJSON(new t(n,s));c.call(this,o,i)}n=n||self;var s="MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now()),c=r||function(e,t){n.postMessage(e,this.targetOrigin,t)},u=new a,v=new a;this.targetOrigin="*",this.addEventListener=v.addEventListener,this.hasEventListener=v.hasEventListener,this.removeEventListener=v.removeEventListener,this.removeAllEventListeners=v.removeAllEventListeners,this.dispatchEvent=o,Object.defineProperties(this,{sender:{value:u},receiver:{value:v},target:{value:n},dispatcherId:{value:s}}),n.addEventListener("message",i)}var t=function(){function t(e,t){this.event=e,this.dispatcherId=t}function n(){return{event:e.toJSON(this.event),dispatcherId:this.dispatcherId}}function r(n){var r=e.fromJSON(n);return t.isEvent(r)?r.event=e.fromJSON(r.event):r=null,r}function i(e){return a.isObject(e)&&e.hasOwnProperty("dispatcherId")&&e.hasOwnProperty("event")}return t.prototype.toJSON=n,t.fromJSON=r,t.isEvent=i,t}();e.toJSON=function(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)},e.fromJSON=function(e){var t;if(a.isObject(e))t=e;else try{t=JSON.parse(e)}catch(n){}return t};var n=null,r=null,i=null;return e.self=function(){return n||(n=new e(self)),n},e.parent=function(){return r||(r=new e(parent)),r},e.top=function(){return i||(i=new e(top)),i},e}(),c={},u={};Object.defineProperties(u,{CONNECT:{value:"connect"},MESSAGE:{value:"message"},ERROR:{value:"error"},LANGUAGECHANGE:{value:"languagechange"},ONLINE:{value:"online"},OFFLINE:{value:"offline"}}),e.createHandler=function(t,n,r){function i(t){r.hasEventListener(o)&&r.dispatchEvent(new e(o,t,t))}var o=e.getWorkerEventType(t);return n.addEventListener(t,i),i},e.getWorkerEventType=function(t){var n="";switch(t){case u.CONNECT:n=e.CONNECT;break;case u.MESSAGE:n=e.MESSAGE;break;case u.ERROR:n=e.ERROR;break;case u.LANGUAGECHANGE:n=e.LANGUAGECHANGE;break;case u.ONLINE:n=e.ONLINE;break;case u.OFFLINE:n=e.OFFLINE}return n},Object.defineProperties(e,{CONNECT:{value:"worker:connect"},MESSAGE:{value:"worker:message"},ERROR:{value:"worker:error"},LANGUAGECHANGE:{value:"worker:languagechange"},ONLINE:{value:"worker:online"},OFFLINE:{value:"worker:offline"}});var v={};Object.defineProperties(v,{DEDICATED_WORKER:{value:"dedicated"},SHARED_WORKER:{value:"shared"},SHARED_WORKER_SERVER:{value:"sharedServer"},SHARED_WORKER_CLIENT:{value:"sharedClient"}});var l=function(){function t(e){function t(t,n){e.postMessage(t,n)}s.call(this,e,t)}function n(t,n){e.createHandler(u.ERROR,t,n),e.createHandler(u.LANGUAGECHANGE,t,n),e.createHandler(u.ONLINE,t,n),e.createHandler(u.OFFLINE,t,n)}function r(t,n){e.createHandler(u.ERROR,t,n)}return t.setScopeHandlers=n,t.setAbstractWorkerHandlers=r,t}();return t.prototype=new o(c,v.SHARED_WORKER_SERVER),t.prototype.constructor=t,n.prototype=new o(c,v.SHARED_WORKER_CLIENT),n.prototype.constructor=n,r.prototype=new o(c,v.SHARED_WORKER),r.prototype.constructor=r,i.prototype=new o(c,v.DEDICATED_WORKER),i.prototype.constructor=i,o.WorkerEvent=e,o.WorkerType=v,o.Dedicated=i,o.Shared=r,o.Server=t,o.Client=n,o.create=function(e,o){var a=null;switch(o){default:case v.DEDICATED_WORKER:a=new i(e);break;case v.SHARED_WORKER:a=new r(e);break;case v.SHARED_WORKER_SERVER:a=new t(e);break;case v.SHARED_WORKER_CLIENT:a=new n(e)}return a},o.self=function(){var e=null;return e="function"==typeof self.postMessage?new i(self):new t(self)},o});