!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.WorkerEventDispatcher=t()}(this,function(){function e(e,t,n,r){o.Event.call(this,e,t),this.sourceEvent=n,this.client=r}function t(t,n){function r(t){var n=a.create(t.ports[0],l.SHARED_WORKER_CLIENT);s.dispatchEvent(new e(e.CONNECT,n,t,n))}var i=t||self,s=new o(n);i.addEventListener("connect",r),this.addEventListener=s.addEventListener,this.hasEventListener=s.hasEventListener,this.removeEventListener=s.removeEventListener,this.removeAllEventListeners=s.removeAllEventListeners,v.setScopeHandlers(i,s),Object.defineProperties(this,{receiver:{value:s},target:{value:i}})}function n(e,t,n){function r(){e.start()}function i(){e.close()}v.call(this,e,t,n),this.start=r,this.close=i}function r(e,t,r,i){var a=e;o.isObject(e)||(a=new SharedWorker(String(e),t)),n.call(this,a.port,r,i),v.setAbstractWorkerHandlers(a,this.receiver)}function i(e,t,n){function r(){return i.terminate()}var i=e||self;o.isObject(i)||(i=new Worker(String(e))),v.call(this,i,t,n),v.setScopeHandlers(i,this.receiver),this.terminate=r}function a(e,t,n,r){e===c?Object.defineProperties(this,{type:{value:t}}):i.call(this,e,n,r)}var o=function(){function e(e){return"object"==typeof e&&null!==e}function t(e){function n(e,t,n){c.add(e,t,-n||0)}function r(e){return c.has(e)}function a(e,t){c.remove(e,t)}function o(e){c.removeAll(e)}function s(n,r){var i=t.getEvent(n,r);e&&(i=e.call(this,i)),c.call(i)}var c=new i;this.addEventListener=n,this.hasEventListener=r,this.removeEventListener=a,this.removeAllEventListeners=o,this.dispatchEvent=s}function n(e,n){var r=e;return t.isObject(e)||(r=new t.Event(String(e),n)),r}var r=function(){function e(){return{type:this.type,data:this.data}}function t(e,t){function n(){return i}function r(){i=!0}var i=!1;Object.defineProperties(this,{type:{value:e,enumerable:!0},data:{value:t||null,enumerable:!0}}),this.preventDefault=r,this.isDefaultPrevented=n}return t.prototype.toJSON=e,t}(),i=function(){function e(e,t,n){var r=a(e,n,this._listeners);r.indexOf(t)<0&&r.push(t)}function t(e){var t=!1,n=o(e,this._listeners);if(n)for(var r in n)if(n.hasOwnProperty(r)){t=!0;break}return t}function n(e,t){var n=o(e,this._listeners);if(n)for(var r=Object.getOwnPropertyNames(n),i=r.length,a=0;i>a;a++){var s=r[a],c=n[s],u=c.indexOf(t);u>=0&&(c.splice(u,1),c.length||delete n[s])}}function r(e){delete this._listeners[e]}function i(e,t){function n(){i=!0}function r(){a=!0}var i=!1,a=!1;e.stopPropagation=n,e.stopImmediatePropagation=r;var s=o(e.type,this._listeners);if(s)for(var c=Object.getOwnPropertyNames(s).sort(function(e,t){return e-t}),u=c.length,l=0;u>l&&!i;l++)for(var v=s[c[l]],E=v.length,f=0;E>f&&!a;f++){var p=v[f];p.call(t,e)}delete e.stopPropagation,delete e.stopImmediatePropagation}function a(e,t,n){var r=o(e,n,Object);return o(parseInt(t),r,Array)}function o(e,t,n){var r=null;return t.hasOwnProperty(e)?r=t[e]:n&&(r=t[e]=new n),r}function s(){this._listeners={}}return s.prototype.add=e,s.prototype.has=t,s.prototype.remove=n,s.prototype.removeAll=r,s.prototype.call=i,s}();return t.isObject=e,t.getEvent=n,t.Event=r,t}(),s=function(){function e(n,r,i,a){function s(e){var n=t.fromJSON(e.data);n&&(n.dispatcherId===u?v.dispatchEvent(n.event):E.dispatchEvent(n.event))}function c(n,r,i){n=o.getEvent(n,r);var a=e.toJSON(new t(n,u));l.call(this,a,i)}n=n||self;var u="MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now()),l=r||function(e,t){n.postMessage(e,this.targetOrigin,t)},v=new o(a),E=new o(i);this.targetOrigin="*",this.addEventListener=E.addEventListener,this.hasEventListener=E.hasEventListener,this.removeEventListener=E.removeEventListener,this.removeAllEventListeners=E.removeAllEventListeners,this.dispatchEvent=c,Object.defineProperties(this,{sender:{value:v},receiver:{value:E},target:{value:n},dispatcherId:{value:u}}),n.addEventListener("message",s)}var t=function(){function t(e,t){this.event=e,this.dispatcherId=t}function n(){return{event:e.toJSON(this.event),dispatcherId:this.dispatcherId}}function r(n){var r=e.fromJSON(n);return t.isEvent(r)?r.event=e.fromJSON(r.event):r=null,r}function i(e){return o.isObject(e)&&e.hasOwnProperty("dispatcherId")&&e.hasOwnProperty("event")}return t.prototype.toJSON=n,t.fromJSON=r,t.isEvent=i,t}();e.toJSON=function(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)},e.fromJSON=function(e){var t;if(o.isObject(e))t=e;else try{t=JSON.parse(e)}catch(n){}return t};var n=null,r=null,i=null;return e.self=function(t,r){return n||(n=new e(self,null,t,r)),n},e.parent=function(t,n){return r||(r=new e(parent,null,t,n)),r},e.top=function(t,n){return i||(i=new e(top,null,t,n)),i},e}(),c={},u={};Object.defineProperties(u,{CONNECT:{value:"connect"},MESSAGE:{value:"message"},ERROR:{value:"error"},LANGUAGECHANGE:{value:"languagechange"},ONLINE:{value:"online"},OFFLINE:{value:"offline"}}),e.createHandler=function(t,n,r){function i(t){r.hasEventListener(a)&&r.dispatchEvent(new e(a,t,t))}var a=e.getWorkerEventType(t);return n.addEventListener(t,i),i},e.getWorkerEventType=function(t){var n="";switch(t){case u.CONNECT:n=e.CONNECT;break;case u.MESSAGE:n=e.MESSAGE;break;case u.ERROR:n=e.ERROR;break;case u.LANGUAGECHANGE:n=e.LANGUAGECHANGE;break;case u.ONLINE:n=e.ONLINE;break;case u.OFFLINE:n=e.OFFLINE}return n},Object.defineProperties(e,{CONNECT:{value:"worker:connect"},MESSAGE:{value:"worker:message"},ERROR:{value:"worker:error"},LANGUAGECHANGE:{value:"worker:languagechange"},ONLINE:{value:"worker:online"},OFFLINE:{value:"worker:offline"}});var l={};Object.defineProperties(l,{DEDICATED_WORKER:{value:"dedicated"},SHARED_WORKER:{value:"shared"},SHARED_WORKER_SERVER:{value:"sharedServer"},SHARED_WORKER_CLIENT:{value:"sharedClient"}});var v=function(){function t(e,t,n){function r(t,n){e.postMessage(t,n)}s.call(this,e,r,t,n)}function n(t,n){e.createHandler(u.ERROR,t,n),e.createHandler(u.LANGUAGECHANGE,t,n),e.createHandler(u.ONLINE,t,n),e.createHandler(u.OFFLINE,t,n)}function r(t,n){e.createHandler(u.ERROR,t,n)}return t.setScopeHandlers=n,t.setAbstractWorkerHandlers=r,t}();return t.prototype=new a(c,l.SHARED_WORKER_SERVER),t.prototype.constructor=t,n.prototype=new a(c,l.SHARED_WORKER_CLIENT),n.prototype.constructor=n,r.prototype=new a(c,l.SHARED_WORKER),r.prototype.constructor=r,i.prototype=new a(c,l.DEDICATED_WORKER),i.prototype.constructor=i,a.WorkerEvent=e,a.WorkerType=l,a.Dedicated=i,a.Shared=r,a.Server=t,a.Client=n,a.create=function(e,a,o,s){var c=null;switch(a){default:case l.DEDICATED_WORKER:c=new i(e,o,s);break;case l.SHARED_WORKER:c=new r(e,null,o,s);break;case l.SHARED_WORKER_SERVER:c=new t(e,o);break;case l.SHARED_WORKER_CLIENT:c=new n(e,o,s)}return c},a.self=function(e,n){var r=null;return r="function"==typeof self.postMessage?new i(self,e,n):new t(self,e)},a});