!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.WorkerEventDispatcher=t()}(this,function(){function e(e,t,r,n){s.Event.call(this,e,t),this.sourceEvent=r,this.client=n}function t(e,t,r,n){e===c?Object.defineProperties(this,{type:{value:n}}):(Object.defineProperties(this,{type:{value:l.DEDICATED_WORKER}}),o.call(this,e,t,r))}function r(r,n){function i(r){var n=t.create(r.ports[0],l.SHARED_WORKER_CLIENT);a.dispatchEvent(new e(e.CONNECT,n,r,n))}var o=r||self,a=new s(n);o.addEventListener("connect",i),this.addEventListener=a.addEventListener.bind(a),this.hasEventListener=a.hasEventListener.bind(a),this.removeEventListener=a.removeEventListener.bind(a),this.removeAllEventListeners=a.removeAllEventListeners.bind(a),v.setScopeHandlers(o,a),Object.defineProperties(this,{receiver:{value:a},target:{value:o},type:{value:l.SHARED_WORKER_SERVER}})}function n(e,t,r){function n(){e.start()}function i(){e.close()}v.call(this,e,t,r),this.start=n,this.close=i}function i(e,t,r,i){var o=e;s.isObject(e)||(o=new SharedWorker(String(e),t)),n.call(this,o.port,r,i),v.setAbstractWorkerHandlers(o,this.receiver)}function o(e,t,r){function n(){return i.terminate()}var i=e||self;s.isObject(i)||(i=new Worker(String(e))),v.call(this,i,t,r),v.setScopeHandlers(i,this.receiver),this.terminate=n}var s=function(){var e=function(){function e(){return{type:this.type,data:this.data}}function t(e,t){function r(){return i}function n(){i=!0}var i=!1;Object.defineProperties(this,{type:{value:e,enumerable:!0},data:{value:t||null,enumerable:!0}}),this.preventDefault=n,this.isDefaultPrevented=r}return t.prototype.toJSON=e,t}(),t=function(){function e(e,t,r){var n=o(e,r,this._listeners);n.indexOf(t)<0&&n.push(t)}function t(e){var t=!1,r=s(e,this._listeners);if(r)for(var n in r)if(r.hasOwnProperty(n)){t=!0;break}return t}function r(e,t){var r=s(e,this._listeners);if(r)for(var n=Object.getOwnPropertyNames(r),i=n.length,o=0;i>o;o++){var a=n[o],c=r[a],u=c.indexOf(t);u>=0&&(c.splice(u,1),c.length||delete r[a])}}function n(e){delete this._listeners[e]}function i(e,t){function r(){i=!0}function n(){o=!0}var i=!1,o=!1;e.stopPropagation=r,e.stopImmediatePropagation=n;var a=s(e.type,this._listeners);if(a)for(var c=Object.getOwnPropertyNames(a).sort(function(e,t){return e-t}),u=c.length,l=0;u>l&&!i;l++)for(var v=a[c[l]],p=v.length,E=0;p>E&&!o;E++){var h=v[E];h.call(t,e)}delete e.stopPropagation,delete e.stopImmediatePropagation}function o(e,t,r){var n=s(e,r,Object);return s(parseInt(t),n,Array)}function s(e,t,r){var n=null;return t.hasOwnProperty(e)?n=t[e]:r&&(n=t[e]=new r),n}function a(){this._listeners={}}return a.prototype.add=e,a.prototype.has=t,a.prototype.remove=r,a.prototype.removeAll=n,a.prototype.call=i,a}(),r={},n=function(){function n(e){e!==r&&(Object.defineProperty(this,E,{value:new t}),Object.defineProperty(this,h,{value:e}))}function i(e,t,r){this[E].add(e,t,-r||0)}function o(e){return this[E].has(e)}function s(e,t){this[E].remove(e,t)}function a(e){this[E].removeAll(e)}function c(e,t){var r=n.getEvent(e,t);this[h]&&(r=this[h].call(this,r)),this[E].call(r)}function u(e){return"object"==typeof e&&null!==e}function l(e,t){var r=e;return n.isObject(e)||(r=new n.Event(String(e),t)),r}function v(e){return new n(e)}function p(){return new n(r)}var E=Symbol("event.dispatcher::listeners"),h=Symbol("event.dispatcher::preprocessor");return n.prototype.addEventListener=i,n.prototype.hasEventListener=o,n.prototype.removeEventListener=s,n.prototype.removeAllEventListeners=a,n.prototype.dispatchEvent=c,n.isObject=u,n.getEvent=l,n.create=v,n.createNoInitPrototype=p,n.Event=e,n}();return n}(),a=function(){var e=function(){function e(e,t){this.event=e,this.dispatcherId=t}function r(){return{event:t.toJSON(this.event),dispatcherId:this.dispatcherId}}function n(r){var n=t.parse(r);return e.isEvent(n)?n.event=t.parse(n.event):n=null,n}function i(e){return s.isObject(e)&&e.hasOwnProperty("dispatcherId")&&e.hasOwnProperty("event")}return e.prototype.toJSON=r,e.parse=n,e.isEvent=i,e}(),t=function(){function t(e,t,r,n){e!==E&&(e=e||self,this[h]={customPostMessageHandler:t,senderEventPreprocessor:n},Object.defineProperties(this,{sender:{value:s.create()},receiver:{value:s.create(r)},target:{value:e},dispatcherId:{value:"MP/"+String(Math.ceil(1e4*Math.random()))+"/"+String(Date.now())}}),this.targetOrigin="*",this.addEventListener=this.receiver.addEventListener.bind(this.receiver),this.hasEventListener=this.receiver.hasEventListener.bind(this.receiver),this.removeEventListener=this.receiver.removeEventListener.bind(this.receiver),this.removeAllEventListeners=this.receiver.removeAllEventListeners.bind(this.receiver),e.addEventListener("message",this._messageEventListener.bind(this)))}function r(r,n,i){r=s.getEvent(r,n),this[h].senderEventPreprocessor&&(r=this[h].senderEventPreprocessor.call(this,r));var o=t.toJSON(new e(r,this.dispatcherId));this._postMessageHandler(o,i)}function n(e,t){var r=this[h].customPostMessageHandler;r?r.call(this,e,t):this.target.postMessage(e,this.targetOrigin,t)}function i(t){var r=e.parse(t.data);r&&(r.dispatcherId===this.dispatcherId?this.sender.dispatchEvent(r.event):this.receiver.dispatchEvent(r.event))}function o(e){var t;return t="function"==typeof e.toJSON?e.toJSON():JSON.stringify(e)}function a(e){var t;if(s.isObject(e))t=e;else try{t=JSON.parse(e)}catch(r){}return t}function c(){return f||(f=new t(self)),f}function u(){return d||(d=new t(parent)),d}function l(){return O||(O=new t(top)),O}function v(e,r,n,i){return new t(e,r,n,i)}function p(){return new t(E)}var E={},h=Symbol("message.port.dispatcher::handlers");t.prototype=s.createNoInitPrototype(),t.prototype.constructor=t,t.prototype.dispatchEvent=r,t.prototype._messageEventListener=i,t.prototype._postMessageHandler=n;var f=null,d=null,O=null;return t.toJSON=o,t.parse=a,t.self=c,t.parent=u,t.top=l,t.create=v,t.createNoInitPrototype=p,t}();return t}(),c={},u={};Object.defineProperties(u,{CONNECT:{value:"connect"},MESSAGE:{value:"message"},ERROR:{value:"error"},LANGUAGECHANGE:{value:"languagechange"},ONLINE:{value:"online"},OFFLINE:{value:"offline"}}),e.createHandler=function(t,r,n){function i(t){n.hasEventListener(o)&&n.dispatchEvent(new e(o,t,t))}var o=e.getWorkerEventType(t);return r.addEventListener(t,i),i},e.getWorkerEventType=function(t){var r="";switch(t){case u.CONNECT:r=e.CONNECT;break;case u.MESSAGE:r=e.MESSAGE;break;case u.ERROR:r=e.ERROR;break;case u.LANGUAGECHANGE:r=e.LANGUAGECHANGE;break;case u.ONLINE:r=e.ONLINE;break;case u.OFFLINE:r=e.OFFLINE}return r},Object.defineProperties(e,{CONNECT:{value:"worker:connect"},MESSAGE:{value:"worker:message"},ERROR:{value:"worker:error"},LANGUAGECHANGE:{value:"worker:languagechange"},ONLINE:{value:"worker:online"},OFFLINE:{value:"worker:offline"}});var l={};Object.defineProperties(l,{DEDICATED_WORKER:{value:"dedicated"},SHARED_WORKER:{value:"shared"},SHARED_WORKER_SERVER:{value:"sharedServer"},SHARED_WORKER_CLIENT:{value:"sharedClient"}});var v=function(){function t(e,t,r){function n(t,r){e.postMessage(t,r)}e!==c&&a.call(this,e,n,t,r)}function r(t,r){e.createHandler(u.ERROR,t,r),e.createHandler(u.LANGUAGECHANGE,t,r),e.createHandler(u.ONLINE,t,r),e.createHandler(u.OFFLINE,t,r)}function n(t,r){e.createHandler(u.ERROR,t,r)}function i(){return new t(c)}return t.prototype=a.createNoInitPrototype(),t.prototype.constructor=t,t.setScopeHandlers=r,t.createNoInitPrototype=i,t.setAbstractWorkerHandlers=n,t}();return t.prototype=v.createNoInitPrototype(),t.prototype.constructor=t,r.prototype=s.createNoInitPrototype(),r.prototype.constructor=r,n.prototype=new t(c,null,null,l.SHARED_WORKER_CLIENT),n.prototype.constructor=n,i.prototype=new t(c,null,null,l.SHARED_WORKER),i.prototype.constructor=i,o.prototype=new t(c,null,null,l.DEDICATED_WORKER),o.prototype.constructor=o,t.WorkerEvent=e,t.WorkerType=l,t.CONNECT_EVENT=e.CONNECT,t.DEDICATED_WORKER=l.DEDICATED_WORKER,t.SHARED_WORKER=l.SHARED_WORKER,t.DedicatedWorker=o,t.SharedWorker=i,t.Server=r,t.Client=n,t.create=function(e,t,s,a){var c=null;switch(t){default:case l.DEDICATED_WORKER:c=new o(e,s,a);break;case l.SHARED_WORKER:c=new i(e,null,s,a);break;case l.SHARED_WORKER_SERVER:c=new r(e,s);break;case l.SHARED_WORKER_CLIENT:c=new n(e,s,a)}return c},t.self=function(e,t){var n=null;return n="function"==typeof self.postMessage?new o(self,e,t):new r(self,e)},t});